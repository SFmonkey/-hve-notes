---
title: 《高性能 javascript》总结
date: Invalid date
tags: [blog]
published: true
hideInList: false
feature: 
---
最近阅读了《高性能 javascript》这本书，虽然在现在看来书中的部分知识已经过时了，但还是有很多值得我们拜读的地方，故总结一下。

## 加载和执行

> 大多数浏览器使用单一进程来处理 UI 刷新和 JS 脚本执行，所以同一时间只能干一件事。 JS 的执行过程耗时越久，浏览器等待响应的时间就越长。

如果外链 JS 的加载不是异步的，它会阻塞 DOM 的解析和渲染。

每次遇到 script 标签，页面都会停下来等待代码的下载（如果是外链JS）并执行，然后处理其他部分。

所以我们需要减少 JS 对于性能的影响。

* 尽可能将 JS 放在 body 标签最后面，这样能确保脚本执行前页面已经完成了渲染

* 合并脚本，页面中的 script 标签越少，加载也就越快

* 无阻塞下载 JS

    * defer async 属性

    * 动态创建 script 标签实现异步加载

    * 使用 XHR 对象下载 JS 代码并注入页面

## 数据存取

> 在 JS 中，数据存储的位置会对代码整体性能产生重大的影响。数据存储共有四种方式：字面量、变量、数组项、对象成员。它们有着各自的性能特点。

* 访问字面量（字面量只代表自身，不存储在特定位置）和局部变量的速度最快，相反，访问数组和对象相对缓慢。

* 变量在作用域链中的位置越深，访问速度也就越慢，由于全局变量处于作用域链的最末端，所以访问速度是最慢的。

* 避免使用 with 语句和 try-catch 中的 catch 子句，因为它们会改变执行环境的作用域链。

* 嵌套的对象成员（如 window.location.href）会明显的影响性能，尽量少用。

* 属性和方法在原型链中的位置越深，访问它的速度就越慢。

* 通过把常用的对象成员，数组元素，跨域变量保存在局部变量中来改善 JS 性能。

## DOM 编程

> 访问和操作 DOM 是现代 Web 应用的重要部分，但每次穿越连接 ECMAScript 和 DOM 两个岛屿之间的桥梁，都会被收取 “过桥费”，为了减少 DOM 编程带来的性能消耗，需要注意一些地方。

* 最小化 DOM 访问次数。

* 如果需要多次访问某个 DOM ，请使用局部变量存储它的引用。

* 小心使用 HTML 集合，因为它实时连系着底层文档，把集合的长度缓存到一个变量中，并在迭代中使用它。如果需要经常操作集合，建议把它拷贝到一个数组中。

* 使用速度更快的 API，比如 querySelectorAll 和 firstElementChild

* 要留意重绘和重排，批量修改样式时，“离线” 操作 DOM 树，使用缓存，并减少访问布局信息的次数。

* 动画中使用绝对定位，使用拖放代理。

* 使用事件委托减少事件处理器的数量。

## 算法和流程控制

> js 和其他编程语言一样，代码的写法和算法会影响运行时间。

* for，while 和 do-while 循环性能相当。

* 避免使用 for-in 循环，除非你需要遍历一个属性数量未知的对象。

* 改善循环性能最佳的方式是减少每次迭代的运算量和减少迭代循环的次数。

* 当条件分支到达一定程度时，对象优于 switch 优于 if-else

* 浏览器的调用栈大小限制了递归算法在 JS 中的应用。

* 任何递归算法都可以用迭代来代替，或使用 Memoization（该函数会缓存特定参数的函数调用结果） 来避免重复计算。

## 字符串和正则表达式

> 密集的字符串操作和草率的编写正则表达式可能会产生严重的性能障碍。

* 在大量的字符串合并中，数组项合并是最慢的字符串连接方法之一，推荐使用简单的 + 和 += 操作符替代。

* 使互邻的字元互斥，避免嵌套量词对同一字符串的相同部分多次匹配，通过重复利用预查的原子组去除不必要的回溯，以此来避免回溯失控。

* 正则表达式并不总是完成工作的最佳方式，尤其当你只搜索字面字符串的时候。

## 快速响应的用户界面

> JS 和用户界面更新在同一个进程中运行，因此一次只能处理一件事情。这意味着当 JS 代码正在运行时，用户界面不能响应输入（点击事件等），反之亦然。高效地管理 UI 线程就是要确保 JS 不能运行太长时间，以避免影响用户体验。

* JS 语句的执行不要超过 50 ms。

* 任何 JS 任务都不应该执行超过 100 ms。过长的运行时间会导致 UI 更新出现明显的延迟，从而对用户体验产生负面影响。

* 定时器可用来安排代码延迟执行，它使得你可以把长时间运行的脚本分解成一系列小的任务。

* 定时器会在延迟时间到达后加入代码执行队列。

* web worker 允许你在 UI 线程外部执行 JS 代码，从而避免锁定 UI。

## Ajax

> 高性能的 Ajax 需要选择正确的数据格式和与之匹配的传输技术。

* JSON 和字符分割的自定义格式是最轻量和响应最快的选择。

* XHR 提供了最完善的控制和灵活性，尽管它会把接收到的所有数据当作字符串。

* 动态脚本注入可以跨域执行 JS 和 JSON，但不能读取信息头，且不安全。

* Multipart XHR 可以用来减少请求数，并处理一个响应中的各种文件类型，但它不能缓存接收到的相应。

* 当需要发送数据时，图片信标是一种简单有效的方法。

* 以上介绍了几种 Ajax 技术： XHR， 动态脚本注入， MXHR，图片信标。Ajax 的存在使你可以不用在服务端就下发全部数据，或在不更新页面的情况下更新内容。

* Ajax 缓存有两种方式：一种是在服务端设置缓存时间，一种是在客户端设置缓存数据变量。

这里有一些使用准则

* 减少请求数，可通过合并 JS 和 CSS文件，或使用 MXHR。

* 缩短页面的加载时间，通过 Ajax 来在页面主要内容加载后，加载剩余内容。

* 知道合适使用 Ajax 库，何时编写自己的 Ajax 代码。

## 编程实践

> JS 提出了一些独一无二的性能挑战，这与你组织代码的方式有关。

* 避免使用 eval() 和 Function() 构造器带来双重求值的性能损耗。同样的，给 setTimeout 和 setInterval 传递函数而不是字符串作为参数。

* 尽量使用直接量创建对象和数组，直接量的创建和初始化都比非直接量形式要快。

* 避免重复的工作，当需要检测浏览器时，可使用延迟加载或条件预加载。

* 在进行数学计算时，考虑使用直接操作数字的二进制形式的位运算。

* 尽量使用 JS 原生方法。

## 构建并部署高性能的 JS 应用

> 构建与部署的过程对基于 JS 的 web 应用的性能有着巨大影响。

* 合并 JS 文件以减少 HTTP 请求数。

* 压缩 JS 文件。

* 服务端压缩（Gzip 等）静态文件。

* 通过正确设置 HTTP 响应头来缓存静态文件，通过向文件名增加时间戳来避免缓存问题。

* 使用 CDN。



> 在高压的环境下，人会快速的成长。