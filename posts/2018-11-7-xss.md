---
title: 前端安全（一）XSS 防御
date: 2018-11-07 14:14:36
tags: [blog]
published: true
hideInList: false
feature: 
---


今天写这么一篇文章，完全是因为自己前些日子碰到的 web 安全问题，自己有了些许经历，所以准备写下来。网上有很多优秀的讲述 web 安全的文章，其中尤为推荐[美团技术团队](https://segmentfault.com/u/meituanjishutuandui)写的系列文章。

当然，网上已有的东西再重写一遍毫无意义，所以我记录的，只是在我看来需要再度提炼和注意的地方。

## 什么 是 XSS 

> Cross-Site Scripting（跨站脚本攻击）简称 XSS，是一种代码注入攻击。攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如 Cookie、SessionID 等，进而危害数据安全。

## XSS 的种类

|类型|存储区|插入点|
|---|---|---|
|存储型 XSS |后端数据库 |HTML|
|反射型 XSS |URL    |HTML|
|DOM型 XSS |后端数据库/前端存储/URL    |前端 JavaScript|

## XSS 攻击要素

* 攻击者提交恶意代码

* 浏览器执行恶意代码

## XSS 防御

我们可以从 XSS 攻击要素和代码层面两个方面来考虑防御

* 从攻击要素防御

    * 攻击者提交恶意代码

    思路：这里能够使用的方法，就是`输入过滤`。

    方法：但在这里做的话有一个问题，前端做过滤可以绕过，后端做过滤又无法预测前端如何展现，当作 HTML 进行展示当然没有问题，但如果当作文本的话，就会出现乱码。

    乱码问题倒是可以解决，在前端，利用反转义重新处理。

    那可以直接不从提交恶意代码角度进行防御吗？既不使用输入过滤？

    * 浏览器执行恶意代码

        从两个思路来解决：

        * 防止 HTML 中出现注入

        * 防止 JavaScript 执行时，执行恶意代码

        方法：
        
        * 后端模版渲染改成纯前端 HTML 渲染，把代码和业务数据分隔开，我们明确的在插入数据阶段选择 HTML 插入或者文本插入。但这样还是存在两个问题，一个是首屏加载问题，一个是 DOM XSS 须单独解决。

        * HTML 转义，说到底，还是进行输入过滤。

    > 由此可以得出，在不能改变后端渲染的前提下，输入过滤是无法避免的。如果改为前端渲染，只需关心 DOM XSS 就好了。至于 DOM XSS，在一些本地存储的场景下，过滤转义也无法避免。

* 从代码层面考虑防御

    我们可以从代码层面来预发和警惕 XSS 攻击。

    我们需要知道 XSS 攻击的来源。

    由上面的 XSS 种类可知，途径大概有以下这些。

    * 用户的 UGC 信息

    * 第三方的链接

    * URL 参数

    * POST 参数

    * Referer （可能来自不可信的来源）

    * Cookie （可能来自其他子域注入）

    * HTML 属性（href，src，style的background-image:url和expression(...)）

    * onload、onerror、onclick、location、onmouseover 等事件

    > 代码层面考虑防御是要求开发者在遇到上述情况足够的警觉，考虑此处是否会出现 XSS 攻击，如果会出现，那么解决方案还是`攻击要素防御`的解决方案。

* 其他防御

    这里列举一些其他的防御手段，当然，这些手段可能无法在所有情况下解决问题。

    * CSP

    * 输入内容长度控制

    * HTTP-only Cookie

    * 验证码

`当然，上面所有的考虑只是出自前后端数据通信安全的前提下，但是 HTTPS 也不一定万无一失`

> 时间已经来到了下半场，剩下的只有残酷的白刃战。




